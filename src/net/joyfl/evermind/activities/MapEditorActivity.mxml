<?xml version="1.0" encoding="utf-8"?>
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009" 
		xmlns:s="library://ns.adobe.com/flex/spark"
		xmlns:e="net.joyfl.evermind.components.*"
		creationComplete="init()"
		enterFrame="enterFrameHandler(event)"
		mouseDown="/*stage.focus = null*/">
	
	<fx:Script>
		<![CDATA[
			import net.joyfl.evermind.controller.NodeController;
			import net.joyfl.evermind.events.EvermindEvent;
			import net.joyfl.evermind.loader.MapLoader;
			import net.joyfl.evermind.models.Map;
			import net.joyfl.evermind.node.NodeView;
			
			private var _loader : MapLoader = new MapLoader();
			
			private var _map : Map;
			
			private var nodeScale:Number;
			private var nodeViewContainer:Sprite;
			private var nodeView:NodeView;
			private var nodeController:NodeController;
			
			private function init() : void
			{
				nodeScale = 1;
				_loader.addEventListener( EvermindEvent.GET_MAP, onGetMap );
				_loader.getMap( data.mapId );
			}
			
			private function onGetMap( e : EvermindEvent ) : void
			{
				_loader.removeEventListener( EvermindEvent.LIST_MAPS, onGetMap );
				
				_map = e.data as Map;
				
				titleInput.text = _map.metadata.title;
				
				nodeViewContainer = new Sprite;
				nodeView = new NodeView( _map.node );
				nodeViewContainer.addChild( nodeView );
				nodeController = new NodeController( this, _map.node, nodeView );
				
				nodeViewContainer.x = canvas.width / 2;
				nodeViewContainer.y = canvas.height / 2;
				
				canvas.addChild( nodeViewContainer );
			}
			
			private function onSaveButtonClick( e : MouseEvent ) : void
			{
				
			}
			
			private function onEditButtonClick( e : MouseEvent ) : void
			{
				if( nodeController.currentNode )
					nodeController.currentNode.textField.requestSoftKeyboard();
			}
			
			private function onRemoveButtonClick ( e : MouseEvent ) : void
			{
				nodeController.removeSelectedNode();
			}
			
			private function onTitleButtonClick( e : MouseEvent ) : void
			{
				// hide title
				if( currentState == "title" )
				{
					titleView.visible = false;
					currentState = "noTitle";
				}
				
				// show title
				else
				{
					titleView.visible = true;
					currentState = "title";
				}
			}
			
			protected function gestureZoomHandler( e : TransformGestureEvent ) : void
			{
				nodeScale *= ( e.scaleX + e.scaleY ) / 2;
			}
			
			protected function enterFrameHandler ( e : Event ) : void
			{
				nodeViewContainer.scaleX = nodeViewContainer.scaleY += (nodeScale-nodeViewContainer.scaleY) * 0.5;
			}
			
			protected function onCanvasMouseDown( e : MouseEvent) : void
			{
				scroller.setStyle( "horizontalScrollPolicy", "off" );
				scroller.setStyle( "verticalScrollPolicy", "off" );
				
			}
			
			protected function onScrollerMouseUp( e : MouseEvent ) : void
			{
				scroller.setStyle( "horizontalScrollPolicy", "on" );
				scroller.setStyle( "verticalScrollPolicy", "on" );
			}
			
		]]>
	</fx:Script>
	
	<s:states>
		<s:State name="title" />
		<s:State name="noTitle" />
	</s:states>
	
	<s:navigationContent>
		<e:ActionBarButton image="@Embed('/../res/button_save.png')" backgroundImage="@Embed('/../res/bottom_actionbar_button_bg.png')" click="onSaveButtonClick( event )" />
		<e:ActionBarButton id="editBtn" image="@Embed('/../res/button_edit.png')" backgroundImage="@Embed('/../res/bottom_actionbar_button_bg.png')" click="onEditButtonClick( event )" />
		<e:ActionBarButton id="removeBtn" image="@Embed('/../res/button_delete.png')" backgroundImage="@Embed('/../res/bottom_actionbar_button_bg.png')" click="onRemoveButtonClick( event )" />
	</s:navigationContent>
	
	<s:actionContent>
		<e:ActionBarButton image.title="@Embed('/../res/button_hide_title.png')" image.noTitle="@Embed('/../res/button_show_title.png')"
						   backgroundImage="@Embed('/../res/bottom_actionbar_button_bg.png')" click="onTitleButtonClick( event )" />
	</s:actionContent>
	
	<s:Scroller id="scroller" top.title="65" top.noTitle="0" width="100%" height="100%" gestureZoom="gestureZoomHandler(event)" mouseUp="onScrollerMouseUp( event )">
		<s:Group id="scrollerContent" horizontalScrollPosition="2048" verticalScrollPosition="2048">
			<s:SpriteVisualElement id="canvas" width="4096" height="4096" mouseDown="onCanvasMouseDown( event )" />
		</s:Group>
	</s:Scroller>
	
	<s:Group id="titleView" left="0" right="0">
		<s:hideEffect>
			<s:Move yTo="-50" />
		</s:hideEffect>
		
		<s:showEffect>
			<s:Move yTo="0" />
		</s:showEffect>
		
		<s:TextInput id="titleInput" left="20" right="20" top="5" contentBackgroundAlpha="0" borderVisible="false" textAlign="center" color="#464F4E" fontWeight="bold" />
		<s:Line left="20" right="20" top="62">
			<s:stroke>
				<s:SolidColorStroke color="#42A79F" weight="2" caps="square" />					
			</s:stroke>
		</s:Line>
	</s:Group>
</s:View>
